---
title: 'MATH3012 worksheet 9:  Log-linear models with interactions'
author: ""
date: ""
output: pdf_document
fontsize: 12pt
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
knitr::opts_knit$set(root.dir = file.path('..', 'datasets'))
```

\subsection*{Finding a suitable model}

The  data in `lymphoma.csv` represents 30 lymphoma 
patients classified by sex (`Sex`), cell type of lymphoma (`Cell`) and response to 
treatment (`Remis`). The aim here is to study the 
complex dependence structures between the three classifying factors. 

Read the data from the file `lymphoma.csv` into a data frame called 
`lymphoma`.
```{r, include = FALSE}
lymphoma <- read.csv("lymphoma.csv")
```

Use `xtabs` to find a three-way ($2\times 2\times 2$) contingency table for this data
```{r, include = FALSE}
xtabs(Count ~ Cell + Sex + Remis, data = lymphoma)
```

Here the saturated model is the three factor
interaction model `Cell * Remis * Sex`. We issue:

```{r}
ly_sat <- glm(Count ~ Cell * Remis * Sex, data = lymphoma, family = poisson)
```

The saturated model fits exactly. 
```{r}
summary(ly_sat)
```
confirms that we have zero deviance.

Now we drop the three factor interaction term.
```{r}
ly_glm1 <- update(ly_sat, . ~ . - Cell:Remis:Sex)
```

Note the colon instead of the `*` in   `Cell:Remis:Sex`.
What would happen if you used `*`?
Which `formula` would you use to fit the same model directly 
(without using `update`)?

Issue 
```{r}
summary(ly_glm1)
anova(ly_glm1, test = "Chisq")
```
From the output,  we can see that
we can remove the `Remis:Sex` term and no more.
We cannot remove any of the
remaining two  interaction terms, `Cell:Remis`
and `Cell:Sex` because of low $p$-values;  we  cannot remove
any lower order terms if they appear in higher order terms. Remember the
*principle of marginality*!

Issue the following two commands.
```{r}
ly_glm2 <- update(ly_glm1, . ~ . - Remis:Sex)
summary(ly_glm2)
```

We issue the following commands to see the quality of fit. Compare
the observed and fitted counts.
```{r}
pcount <- predict(ly_glm2, type = "response")

data.frame(observed=lymphoma$Count, fitted=pcount)
```

## Investigating  the dependence structure


Absence of the interaction term  `Remis:Sex` from `ly_glm2`
does not imply the independence of remission and sex. It merely implies
that remission  is independent of sex  *conditional on* cell type, that is
$$
P(R,S|C)=P(R|C)P(S|C).
$$
Another way of expressing this is
$$
P(R|S,C)=P(R|C),
$$
that is, the probability of each level of $R$
given a particular combination of $S$ and $C$, does not
depend on which level $S$ takes.
Equivalently, we can write $P(S|R,C)=P(S|C)$.
This can be observed by calculating the estimated odds in favour
of $R=$ yes over $R=$ no for the `lymphoma` dataset.

We now illustrate the above theory. We first find the
8 fitted probabilities which are simply the  fitted counts divided
by 30 (which is the total number of patients classified).

```{r}
fit.prob <- pcount/(sum(pcount))
fit.prob
```


Subsequently, we form the odds ratios by dividing the probabilities,
e.g. $\frac{0.1282}{0.0385} = 3.33$.

Check that you can replicate Table 3.9 from the notes.
The odds depend only on a patient's Cell type, and not on their
Sex. This means that remission  and sex are conditionally
independent given cell type. Are they marginally independent?

