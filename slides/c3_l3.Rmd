---
title: "MATH3012: Chapter 3, Lecture 3"
date: ""
author: Helen Ogden
header-includes:
- \usepackage{bm}
- \usepackage{booktabs, multirow}
output:
  beamer_presentation
---


```{r, echo = FALSE}
knitr::opts_knit$set(root.dir = '../datasets')
```
## Recap

- A log-linear model is a Poisson GLM with the canonical link function (the 
log link). We can use log-linear models to model contingency table data,
and find expected cell counts.
- If the total count is fixed, a multinomial model is
more natural than a Poisson one.
- How should we do inference for a multinomial model?

## Recap: the multinomial distribution

The multinomial distribution is the distribution of cell counts arising
when a prespecified total of $N$ items are each independently assigned to
one of $n$ cells, where the probability of being classified into cell
$i$ is $p_i$, ${i=1,\ldots ,n}$, so $\sum_{i=1}^n p_i=1.$

The probability function for the multinomial distribution is
\vspace{-1cm}
\begin{align*}
f_{\bm{Y}}(\bm{y};{\bf p})
&= P(Y_1=y_1,\ldots ,Y_n=y_n) \cr
&= \begin{cases} 
N!\prod_{i=1}^n \frac{p_i^{y_i}}{y_i!} & \text{if $\sum_{i=1}^n y_i=N$} \\
0 & \text{otherwise.}
\end{cases}
\end{align*}
The binomial is the special
case of the multinomial with two cells ($n=2$).


## A multinomial log-linear model

When the data
have been obtained by multinomial sampling, we suppose
$\bm Y \sim \text{Multinomial}(N, \bm p)$, where
$\log\mu_i=\log(Np_i)$, ${i=1,\ldots ,n}$ 
is modelled as as a linear function of
explanatory variables, so that 
$\log \mu_i = \bm{x}_i^T \bm{\beta}$.

Since $\sum_{i=1}^n p_i = 1$, we have
$\sum_{i=1}^n \mu_i=N$, the grand total
which is fixed in advance.


## Equivalence of Poisson log-linear model

Suppose we model instead $Y_i \sim \text{Poisson}(\mu_i)$,
where $\log \mu_i = \bm{x}_i^T \bm{\beta}$.
Suppose that we include an intercept term: e.g.
$x_{i1} = 1$ for $i = 1,\ldots, n$, so 
$\log \mu_i = \beta_1 + \sum_{j=2}^p x_{ij} \beta_j$.

\pause

**Result**:
The maximum likelihood estimates for multinomial log-linear
parameters are identical to those for Poisson log-linear parameters.
Furthermore, the maximised log-likelihoods for both Poisson and multinomial
models take the form $\sum_{i=1}^ny_i\log\hat{\mu}_i$, where
$\hat{\mu}_i = \bm{x}_i^T \bm{\beta}$.

\pause
A sketch proof of this result is in the notes. The proof of this
result is non-examinable.

## Implications of the equivalence result

Recall that the maximised log-likelihoods for both Poisson and multinomial
models take the form $\sum_{i=1}^ny_i\log\hat{\mu}_i$ as functions of
the log-linear parameter estimates.

So any inferences based on maximised log-likelihoods (such as likelihood
ratio tests) will be the same.

Therefore, we can analyse contingency table data using Poisson log-linear
models, even when the data has been obtained by multinomial sampling.
All that is required is that we ensure that the Poisson model
contains an intercept term.


## Sampling with fixed margins

Sometimes margins other than just the grand total may be prespecified.

For example, consider the `lymphoma` contingency table.


\begin{center}
\begin{tabular}{lrrr}
\toprule
 & & \multicolumn{2}{c}{Remission} \\
 \cmidrule{3-4}
Cell Type & Sex  & No & Yes\\
\midrule
\multirow{2}{*}{Diffuse} & Female & 3 & 1\\
 & Male & 12 & 1\\
 \midrule
\multirow{2}{*}{Nodular} & Female & 2 & 6\\
 & Male & 1 & 4\\
\bottomrule
\end{tabular}
\end{center}

It may have been decided
at the outset to collect data on 18 male patients and 12 female patients.
Alternatively, perhaps the distribution of both the Sex and Cell type of
the patients was fixed in advance.


## Product multinomial sampling

In cases where a margin is fixed by design, the data consist of a number of
fixed total subgroups, defined by the fixed margin. Neither Poisson
nor multinomial sampling assumptions are valid.


The appropriate distribution combines a separate, independent
multinomial for each subgroup:

-  if the Sex margin is fixed, then we should model the data with two independent
   multinomials, one for males with $N=18$ and one for females with $N=12$.
   Each of these multinomials has four cells, representing the
   cross-classification of the relevant patients by Cell Type and Remission.
- if the Cell type/Sex margin has been fixed, then
  the appropriate distribution is four independent two-cell multinomials
  (binomials) representing the remission classification for each of the
  four fixed-total patient subgroups.

## The product multinomial distribution

When the data are modelled using independent multinomials, then the joint
probability function for the cell counts $Y_1, \ldots, Y_n$ is the product of multinomial probability functions, one for each fixed-total subgroup.
We call this a distribution a *product multinomial*.


For example, if the Sex margin is fixed for `lymphoma`,
then the product multinomial distribution has the form
\scriptsize
\[f_{\bm{Y}}(\bm{y};{\bf p})=
\begin{cases}
N_m!\prod_{i=1}^4 {{p_{mi}^{y_{mi}}}\over{y_{mi}!}}
N_f!\prod_{i=1}^4 {{p_{fi}^{y_{fi}}}\over{y_{fi}!}} &
\text{if $\sum_{i=1}^4 y_{mi}=N_m$ and
$\sum_{i=1}^4 y_{fi}=N_f$} \\
0 & \text{otherwise,}
\end{cases}
\]
\normalsize
where 

- $N_m$ and $N_f$ are the two fixed marginal totals (18 and 12
	respectively)
- $y_{m1},\ldots ,y_{m4}$  are the cell counts for males and
  $y_{f1},\ldots ,y_{f4}$  are the corresponding cell counts for females.
- $\sum_{i=1}^4 p_{mi}=\sum_{i=1}^4 p_{fi}=1$.

## Analysis using Poisson log-linear models

Using similar reasoning to the multinomial sampling case,
we can
analyse contingency table data using Poisson log-linear models, even when the
data has been obtained by product multinomial sampling.

 However, we must ensure
that the Poisson model contains a term corresponding to the fixed margin
(and all marginal terms). Then, the estimated means
for the specified margin are equal to the corresponding
fixed totals.

## Example: `lymphoma` data

For the `lymphoma` dataset, for inferences obtained using a Poisson model to be
valid when the Sex margin is fixed in advance, the Poisson model must contain
the Sex main effect (and the intercept).

For inferences obtained using a Poisson model to be
valid when the Cell type/Sex margin is fixed in advance, the Poisson model must
contain the Cell type/Sex interaction, and all marginal terms
(the Cell type main effect, the Sex main effect and the intercept).

Therefore, when analysing product multinomial data using
a Poisson log-linear model, certain terms **must** be present in any
model we fit. If they are removed, the inferences would no longer be
valid.



## Interpreting log-linear models

Log-linear models for contingency tables enable us to determine
important properties concerning the joint distribution
of the classifying variables. The form of our preferred
log linear model for a table will have implications for how
the variables are associated.

Each combination of
the classifying variables occurs exactly once in a contingency table.
Therefore, the model with the highest order interaction
(between all the variables) and all marginal terms (all other interactions)
is the saturated model.

The implication of this model is that every combination of levels
of the variables has its own mean (probability) and that there are no
relationships between these means (no structure).
The variables are highly dependent.


## Example: return to the `job` dataset

In the `job` dataset, we might assume that the number
of people in each income group is fixed. We are interested
in the probability of having each level of satisfaction
at each income group, and seeing whether there is any
evidence in this data that job satisfaction depends on income.

\scriptsize
\begin{center}
\begin{tabular}{lrrrrr}
\toprule
  & \multicolumn{4}{c}{Job Satisfaction}  & \\
  \cmidrule{2-5}
Income (\$) & Very Dissat. & A Little Dissat. & Moderately Sat. & Very Sat. &
{\bf Sum}\\
\midrule
<6000 & 20 & 24 & 80 & 82 & {\bf 206}\\
6000-15000 & 22 & 38 & 104 & 125 & {\bf 289}\\
15000-25000 & 13 & 28 & 81 & 113 & {\bf 235}\\
>25000 & 7 & 18 & 54 & 92 & {\bf 171}\\
{\bf Sum} & {\bf 62} & {\bf 108} & {\bf 319} & {\bf 412} & {\bf 901} \\
\bottomrule
\end{tabular}
\end{center}

## Fitting log-linear models

This is an example of product multinomial sampling,
with the `Income` margin fixed: provided that
we include an intercept and `Income` in the model, 
we can use Poisson log-linear models to analyse
the contingency table (as we did before).


```{r, include = FALSE}
job <- read.csv("job.csv")
job$Income <- factor(job$Income, levels = c("<6000", "6000-15000", "15000-25000", ">25000"))
job$Satisfaction <- factor(job$Satisfaction, 
levels = c("Very Dissatisfied", "A Little Dissatisfied", "Moderately Satisfied", "Very Satisfied"))
```
```{r}
loglin_job_1 <- glm(Count ~ Income + Satisfaction, 
                    family = poisson, data = job)
loglin_job_2 <- glm(Count ~ Income * Satisfaction, 
                    family = poisson, data = job)
```

## Comparing models

As before, we can compare these models with a log-likelihood
ratio test:
```{r}
anova(loglin_job_1, loglin_job_2, test = "LRT")
```

\normalsize
On the basis of this, we prefer `loglin_job_1`, 
which does not have an interaction between `Income`
and `Satisfaction`.

## Expected cell counts for `loglin_job_1`

The fitted values $\hat \mu_i = \exp(\bm x_i^T \hat {\bm \beta})$
give us the
expected counts in each cell of the contingency table.

\scriptsize
```{r}
fit1_tab <- xtabs(fitted(loglin_job_1) ~ Income + Satisfaction,
                  data = job)
addmargins(fit1_tab)
```


## Fitted conditional probabilities ([web.meetoo.com](https://web.meetoo.com), 108-197-366)

Under `loglin_job_1`, the expected cell counts
for Income < 6000 are

\scriptsize
```{r, echo = FALSE}
fit1_tab[1,]
```
\normalsize
Under this model, what is the estimate of the probability
\[P(\text{Satisfaction = Very Satisfied} | \text{Income < 6000})?\]

- $94.2 / 100 = 0.94$
- $94.2 / (14.2 + 24.6 + 72.9) = 0.84$
- $94.2 / (14.2 + 24.6 + 72.9 + 94.2) = 0.46$
- $94.2 / 901 = 0.10$


## Fitted conditional probabilities ([web.meetoo.com](https://web.meetoo.com), 108-197-366)

Under `loglin_job_1`, the expected cell counts
for Income 6000 - 15000 are

\scriptsize
```{r, echo = FALSE}
fit1_tab[2,]
```
\normalsize
Under this model, what is the estimate of the probability
\[P(\text{Satisfaction = Very Satisfied} | \text{Income = 6000 - 15000})?\]

- $132.2 / (19.9 + 34.6 + 102.3) = 0.84$
- $132.2 / (19.9 + 34.6 + 102.3 + 132.2) = 0.46$
- $132.2 / 901 = 0.15$


## Fitted conditional probabilities for `loglin_job_1'

The fitted conditional probability for each satisfaction
level are
\scriptsize
```{r}
fit1_tab[1,] / sum(fit1_tab[1,])
```
\normalsize
for Income < 6000, and
\scriptsize
```{r}
fit1_tab[2,] / sum(fit1_tab[2,])
```
\normalsize
for Income 6000-15000.
In fact, we get the **same** fitted conditional probabilities for each 
income. Under this model, Income and Satisfaction 
are independent!




## Conclusion

- We have considered multinomial and product multinomial models,
appropriate when the grand total or some margin is fixed.
We can still analyse such
contingency tables using a Poisson log-linear models,
provided we include certain terms (corresponding to the
fixed margin) in the model.
- We have seen an example of a log-linear model for a two-way table,
with no interaction between classifying variables. For this model, we
found that the classifying variables are independent of one another.
It turns out that a similar result holds for any two-way table: we will show this next time,
and look at interpretation of multi-way tables.
- Reminder: the coursework deadline is 5pm today.
- There is no lecture on Monday, because it is a bank holiday.
