---
title: "MATH3012: Chapter 3, Lecture 1"
date: ""
author: Helen Ogden
header-includes:
- \usepackage{bm}
- \usepackage{booktabs, multirow}
output:
  beamer_presentation
---


```{r, echo = FALSE}
knitr::opts_knit$set(root.dir = '../datasets')
```

## Introduction

A particularly important application of generalised linear models
is the analysis of categorical data.
Here, the data are observations of one or more categorical variables
on each of a number of units (often individuals).
Therefore, each of the units are **cross-classified** by the categorical
variables.

For example, the `job` dataset gives the job satisfaction
and income band of 901
individuals from the 1984 General Social Survey.

\scriptsize
\centering
\begin{tabular}{lrrrr}
\toprule
  & \multicolumn{4}{c}{Job Satisfaction} \\
Income (\$) & Very Dissat. & A Little Dissat. & Moderately Sat. & Very Sat. \\
\midrule
<6000 & 20 & 24 & 80 & 82\\
6000-15000 & 22 & 38 & 104 & 125\\
15000-25000 & 13 & 28 & 81 & 113\\
>25000 & 7 & 18 & 54 & 92\\
\bottomrule
\end{tabular}


## Contingency tables

A cross-classification table like this is called a **contingency table**.
This is a **two-way table**, as there are two classifying variables.

It might also be describe as a $4\times 4$ contingency table
(as each of the classifying variables takes one of four possible levels).

Each position in a contingency table is called a **cell** and the
number of individuals in a particular cell is the **cell count**.

Partial classifications derived from the table are called **margins**.
For a two-way table these are often displayed in the
margins of the table.

Our aim in Chapter 3 is to model the cell counts of a contingency
table, to be able to say something about the relationship between
the cross-classifying variables. For example, is there a relationship
between income and job satisfaction?

## A contingency table of the `job` dataset, with margins

\scriptsize
\begin{center}
\begin{tabular}{lrrrrr}
\toprule
  & \multicolumn{4}{c}{Job Satisfaction}  & \\
  \cmidrule{2-5}
Income (\$) & Very Dissat. & A Little Dissat. & Moderately Sat. & Very Sat. &
{\bf Sum}\\
\midrule
<6000 & 20 & 24 & 80 & 82 & {\bf 206}\\
6000-15000 & 22 & 38 & 104 & 125 & {\bf 289}\\
15000-25000 & 13 & 28 & 81 & 113 & {\bf 235}\\
>25000 & 7 & 18 & 54 & 92 & {\bf 171}\\
{\bf Sum} & {\bf 62} & {\bf 108} & {\bf 319} & {\bf 412} & {\bf 901} \\
\bottomrule
\end{tabular}
\end{center}

\normalsize
We have added **one-way margins**, which represent the classification of items by
a single variable; income group and job satisfaction respectively.

## A three-way contingency table

The `lymphoma` dataset gives information about 30 patients, classified
by cell type of lymphoma, sex, and response to treatment. This is an example of a
three-way contingency table. It is a $2\times 2\times 2$ or $2^3$ table.

\begin{center}
\begin{tabular}{lrrr}
\toprule
 & & \multicolumn{2}{c}{Remission} \\
 \cmidrule{3-4}
Cell Type & Sex  & No & Yes\\
\midrule
\multirow{2}{*}{Diffuse} & Female & 3 & 1\\
 & Male & 12 & 1\\
 \midrule
\multirow{2}{*}{Nodular} & Female & 2 & 6\\
 & Male & 1 & 4\\
\bottomrule
\end{tabular}
\end{center}

## Higher-order margins

For **multiway** tables, higher order margins may be calculated.
For example, for `lymphoma`, the two-way Cell type/Sex margin is:

\begin{center}
\begin{tabular}{lrr}
\toprule
&  \multicolumn{2}{c}{Sex} \\
\cmidrule{2-3}
Cell Type  & Female & Male\\
\midrule
Diffuse & 4 & 13\\
Nodular & 8 & 5\\
\bottomrule
\end{tabular}
\end{center}

## Modelling contingency table data

We can model contingency table data using generalised linear models.

To do this, we assume that the cell counts are observations
of independent Poisson random variables.

This is intuitively sensible as the cell counts are non-negative integers
(the sample space for the Poisson distribution).

Therefore, if the table has $n$ cells, which we label $1,\ldots ,n$, then
the observed cell counts $y_1,\ldots ,y_n$ are assumed to be observations
of independent Poisson random variables $Y_1,\ldots ,Y_n$.

We denote the means of these Poisson random variables by $\mu_1,\ldots ,\mu_n$.


## Log-linear models

The canonical link function for the Poisson distribution
is the log function, and we assume this link function throughout.
A generalised linear model for Poisson data using
the log link function is called a **log-linear model**.


The explanatory variables in a log-linear model for contingency table data are
the cross-classifying variables. 

As these variables are categorical, they are
**factors**. As usual with factors, we can include interactions in the model
as well as just main effects. 

Such a model will describe how the expected count
in each cell depends on the classifying variables, and any interactions between
them. Interpretation of these models will be discussed later on.

## `job` dataset in long format

The original data structure of the `job` dataset is

\scriptsize
\begin{center}
\begin{tabular}{llr}
\toprule
Income & Satisfaction & Count\\
\midrule
<6000 & Very Dissatisfied & 20\\
<6000 & A Little Dissatisfied & 24\\
<6000 & Moderately Satisfied & 80\\
<6000 & Very Satisfied & 82\\
6000-15000 & Very Dissatisfied & 22\\
6000-15000 & A Little Dissatisfied & 38\\
6000-15000 & Moderately Satisfied & 104\\
6000-15000 & Very Satisfied & 125\\
15000-25000 & Very Dissatisfied & 13\\
15000-25000 & A Little Dissatisfied & 28\\
15000-25000 & Moderately Satisfied & 81\\
15000-25000 & Very Satisfied & 113\\
>25000 & Very Dissatisfied & 7\\
>25000 & A Little Dissatisfied & 18\\
>25000 & Moderately Satisfied & 54\\
>25000 & Very Satisfied & 92\\
\bottomrule
\end{tabular}
\end{center}



## Log-linear models for `job`

The original format of the `job` dataset the same data 
as the contingency table,
but in a different format, sometimes called **long** format.

A log-linear model is just a Poisson GLM, where
the response variable is `Count`, and `Income`
and `Satisfaction` are explanatory variables.

```{r, include = FALSE}
job <- read.csv("job.csv")
```
```{r}
loglin_job_1 <- glm(Count ~ Income + Satisfaction, 
                    family = poisson, data = job)
loglin_job_2 <- glm(Count ~ Income * Satisfaction, 
                    family = poisson, data = job)
```

## Comparing two models ([web.meetoo.com](https://web.meetoo.com), 108-197-366)

```{r}
loglin_job_1 <- glm(Count ~ Income + Satisfaction, 
                    family = poisson, data = job)
loglin_job_2 <- glm(Count ~ Income * Satisfaction, 
                    family = poisson, data = job)
```
Recall `Income` and 
`Satisfaction` are both factors with 4 levels.

What is $q$, the number of parameters in `loglin_job_1`?

\pause

What is $p$, the number of parameters in `loglin_job_2`?


## Comparing two models

Now we conduct a log likelihood ratio test to compare the two models.
\scriptsize
```{r}
anova(loglin_job_1, loglin_job_2)
```
\normalsize
Here $L_{01}$ is $12.037$, given in the deviance column.

## Comparing two models ([web.meetoo.com](https://web.meetoo.com), 108-197-366)

Under $H_0$, $L_{01} \sim \chi^2_9$. 

We should reject $H_0$ if $L_{01} > k$. Which of the following
commands could be used to find $k$, for a test at the $5\%$ level?

- `dchisq(0.05, df = 9)`
- `dchisq(0.95, df = 9)`
- `pchisq(0.05, df = 9)`
- `pchisq(0.95, df = 9)`
- `qchisq(0.05, df = 9)`
- `qchisq(0.95, df = 9)`

##  Comparing two models ([web.meetoo.com](https://web.meetoo.com), 108-197-366)

```{r}
qchisq(0.95, df = 9)
```
Since $L_{01} =  12.037 < 16.9$, we do not reject $H_0$, and
we prefer the simpler model, `loglin_job_1`.

Later, we'll see that we can interpret `loglin_job_1` as meaning
that there is no dependence
of job satisfaction on income.

## Recap: `lymphoma` data contingency table

\begin{center}
\begin{tabular}{lrrr}
\toprule
 & & \multicolumn{2}{c}{Remission} \\
 \cmidrule{3-4}
Cell Type & Sex  & No & Yes\\
\midrule
\multirow{2}{*}{Diffuse} & Female & 3 & 1\\
 & Male & 12 & 1\\
 \midrule
\multirow{2}{*}{Nodular} & Female & 2 & 6\\
 & Male & 1 & 4\\
\bottomrule
\end{tabular}
\end{center}

## The `lymphoma` data in long format

\begin{center}
\begin{tabular}{lllr}
\toprule
Cell & Sex & Remis & Count\\
\midrule
Nodular & Male & No & 1\\
Nodular & Male & Yes & 4\\
Nodular & Female & No & 2\\
Nodular & Female & Yes & 6\\
Diffuse & Male & No & 12\\
Diffuse & Male & Yes & 1\\
Diffuse & Female & No & 3\\
Diffuse & Female & Yes & 1\\
\bottomrule
\end{tabular}
\end{center}

## A log-linear model for `lymphoma`

A log-linear model for the contingency table is just a Poisson GLM
for this data, where in this case
the response variable is `Count`, and `Sex`, `Remis` and `Cell` are explanatory variables.

The aim is to understand how the probability of remission varies
by type of lymphoma and sex.

We'll consider log-linear models for this in computer worksheet 9.

\pause

In some cases, it might seem more natural to consider a
binomial model for the number of patients in remission, given
the total number in each group. We'll see later on that the inference
assuming this binomial model would be the same as assuming the Poisson
log-linear model.


## Conclusion

- We have introduced the idea of a contingency table: a cross-classification
of counts according to categorical variables.
- A log-linear model is a Poisson GLM with the canonical link function (the 
log link). We can use log-linear models to model contingency table data.
- Sometimes, the Poisson distribution doesn't seem to be a natural
model for the data. We'll consider multinomial models (an extension
of the binomial to more than two categories), and show that we make the same
conclusions about the relationships between variables with either model.

